## 事务的实现与日志（redo log 和 undo log）

在数据库中，事务的实现涉及到日志的记录和处理，其中redo log和undo log是关键的组成部分。它们保证了事务的原子性、持久性和一致性。

### 1. Redo Log（重做日志）

#### 作用：
- **持久性（Durability）**：确保事务的提交操作被写入到磁盘，即使发生数据库崩溃也能够通过重做日志进行恢复。
- **原子性（Atomicity）**：保证事务的所有操作要么全部执行成功，要么全部执行失败，通过重做日志来恢复中间状态。

#### 组成部分：
- **Redo Log Buffer（重做日志缓冲区）**：存储事务对数据的修改操作，在事务提交前先写入到这个缓冲区。
- **Redo Log File（重做日志文件）**：实际的磁盘文件，记录了所有事务对数据的修改操作。

#### 过程：
1. **事务的修改操作**：在事务执行过程中，对数据的修改操作首先被写入到Redo Log Buffer中，而不是直接写入到磁盘上的数据文件。
2. **事务提交**：当事务提交时，将Redo Log Buffer中的日志写入到Redo Log File中。
3. **持久化**：虽然事务提交了，但数据文件可能尚未更新。但由于Redo Log File的持久化特性，即便系统崩溃，也可以通过重做日志进行数据恢复。

### 2. Undo Log（撤销日志）

#### 作用：
- **一致性（Consistency）**：保证了事务的撤销操作可以回滚事务的修改，使数据回到事务开始前的状态。

#### 组成部分：
- **Undo Log Segment（撤销日志段）**：用于记录事务对数据的修改操作的逆操作，即撤销操作。

#### 过程：
1. **事务的修改操作**：在事务执行过程中，对数据的修改操作同时也记录到Undo Log中。
2. **事务回滚**：如果事务需要回滚，系统可以利用Undo Log中的记录来撤销事务对数据的修改操作，将数据恢复到事务开始前的状态。

### 3. Redo Log和Undo Log的区别：

- **Redo Log**：记录事务对数据的修改操作的最新值，用于在崩溃后的数据恢复和事务的持久性。
- **Undo Log**：记录事务对数据的修改操作的逆操作，用于事务的回滚和一致性。

### 4. Redo Log 落盘策略：

事务的日志是先写入到`redo log buffer `中是很快的，那如何保证`redo log buffer`中的信息高效的落到磁盘日志文件中呢？

- `redo log buffer`不是直接将日志内容刷盘到`redo log file`中。
- `redo log buffer`内容先刷入到操作系统的文件系统缓存 （`page cache`）中去，这个过程很快，而且整个系统宕机概率相对MySQL会小很多。
- 最后，日志内容会从操作系统的文件系统缓存中刷到磁盘的日志文件中，至于什么时候触发这个动作，MySQL的innoDB引擎提供了3种策略可选。

`InnoDB`引擎提供了 `innodb_flush_log_at_trx_commit` 参数，该参数控制 `commit`提交事务时，如何将 `redo log buffer `中的日志刷新到 `redo log file `的3种策略。

1. 当 `innodb_flush_log_at_trx_commit` 设为 1 时，每次你提交一个操作（比如插入、更新、删除数据），InnoDB 都会立即把这个操作记录到日志文件里，并确保这个日志文件中的数据被安全地保存到了磁盘上。这样做可以保证数据库操作的安全性，但会影响性能。
2. 当 `innodb_flush_log_at_trx_commit` 设为 2 时，每次你提交一个操作，InnoDB 会把这个操作记录到文件系统的缓存里，但并不会立即把文件系统的缓存的数据保存到磁盘上，而是每秒钟才会把一批操作的日志一次性地写入到磁盘。这样做可以提高性能，但可能会导致在某些情况下丢失一些数据，比如操作系统死机，导致1s的数据丢失，数据库挂了没关系，因为文件系统缓存中有。
3. 当 `innodb_flush_log_at_trx_commit` 设为 0 时，InnoDB 每秒钟会把日志缓冲中的数据写入到磁盘上，但这个写入的操作可能会被一些特殊的数据库操作（比如数据库结构的更改）所影响，不能完全保证每秒钟都写入一次。这样做可以提高性能，但在一些情况下可能会导致丢失最多一秒钟的数据。

总的来说，1 是最安全的，但性能开销大；2 是一种折中，可以提高性能但有一定风险；0 是最高性能但风险最大。根据实际需求和对数据安全性的要求来选择合适的设置。

1. 。

### 总结：
- 事务的实现依赖于日志的记录和处理。
- Redo Log负责保证事务的持久性和原子性，记录事务的最新值。
- Undo Log负责保证事务的一致性，记录事务的逆操作。
- 提交时强制写日志是为了保证事务的持久性和原子性。

